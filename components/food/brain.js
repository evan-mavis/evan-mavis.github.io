const sTierImages = [
  {
    src: "../../assets/imgs/food/japan-osaka-scallop.jpeg",
    alt: "Scallop - Osaka, Japan",
  },
  {
    src: "../../assets/imgs/food/japan-kyoto-ramen.jpeg",
    alt: "Ramen - Kyoto, Japan",
  },
  {
    src: "../../assets/imgs/food/japan-tokyo-tuna-market.jpeg",
    alt: "Tuna Market - Tokyo, Japan",
  },
  {
    src: "../../assets/imgs/food/japan-tokyo-wagyu.jpeg",
    alt: "Wagyu Beef - Tokyo, Japan",
  },
  {
    src: "../../assets/imgs/food/japan-osaka-a5-kobe-wagyu-skewers.jpeg",
    alt: "A5 Kobe Wagyu Skewers - Osaka, Japan",
  },
  {
    src: "../../assets/imgs/food/bali-ubud-dragon-fruit-bfast-bowl.jpeg",
    alt: "Dragon Fruit Breakfast Bowl - Ubud, Bali",
  },
  {
    src: "../../assets/imgs/food/japan-osaka-fatty-toro.jpeg",
    alt: "Fatty Toro - Osaka, Japan",
  },
  {
    src: "../../assets/imgs/food/vietnam-hoi-an-cao-lau-noodles.jpeg",
    alt: "Cao Lau Noodles - Hoi An, Vietnam",
  },
  {
    src: "../../assets/imgs/food/bali-uluwatu-mie-goreng-and-pork-buns.jpeg",
    alt: "Mie Goreng and Pork Buns - Uluwatu, Bali",
  },
  {
    src: "../../assets/imgs/food/japan-tokyo-ramen.jpeg",
    alt: "Ramen - Tokyo, Japan",
  },
  {
    src: "../../assets/imgs/food/vietnam-tam-coc-indian.jpeg",
    alt: "Tikka Masala - Tam Coc, Vietnam",
  },
];

const aTierImages = [
  {
    src: "../../assets/imgs/food/japan-kyoto-wagyu-night.jpeg",
    alt: "Wagyu Night! - Kyoto, Japan",
  },
  {
    src: "../../assets/imgs/food/bali-ubud-breakfast-scramble.jpeg",
    alt: "Chili Egg Scramble - Ubud, Bali",
  },
  {
    src: "../../assets/imgs/food/japan-osaka-nigiri.jpeg",
    alt: "Nigiri - Osaka, Japan",
  },
  {
    src: "../../assets/imgs/food/bali-uluwatu-potstickers.jpeg",
    alt: "Potstickers - Uluwatu, Bali",
  },
  {
    src: "../../assets/imgs/food/japan-tokyo-omakase-unagi.jpeg",
    alt: "Omakase, Unagi - Tokyo, Japan",
  },
  {
    src: "../../assets/imgs/food/japan-tokyo-nigiri.jpeg",
    alt: "Nigiri - Tokyo, Japan",
  },
  {
    src: "../../assets/imgs/food/japan-osaka-dumplings.jpeg",
    alt: "Dumplings - Osaka, Japan",
  },
  {
    src: "../../assets/imgs/food/vietnam-ho-chi-minh-pho-dau.jpeg",
    alt: "Pho Dau - Ho Chi Minh City, Vietnam",
  },
  {
    src: "../../assets/imgs/food/vietnam-hanoi-rich-dipping-noodles.jpeg",
    alt: "Rich Dipping Noodles - Hanoi, Vietnam",
  },
  {
    src: "../../assets/imgs/food/bali-uluwatu-mie-goreng.jpeg",
    alt: "Mie Goreng - Uluwatu, Bali",
  },
  {
    src: "../../assets/imgs/food/japan-kyoto-ramen-2.jpeg",
    alt: "Ramen - Kyoto, Japan",
  },
];

const bTierImages = [
  {
    src: "../../assets/imgs/food/bali-ubud-indian.jpeg",
    alt: "Tikka Masala - Ubud, Bali",
  },
  {
    src: "../../assets/imgs/food/japan-kyoto-cold-soba-and-tempura.jpeg",
    alt: "Cold Soba and Tempura - Kyoto, Japan",
  },
  {
    src: "../../assets/imgs/food/japan-tokyo-ichiran.jpeg",
    alt: "Ichiran Ramen - Tokyo, Japan",
  },
  {
    src: "../../assets/imgs/food/japan-osaka-cold-breakfast-noodles.jpeg",
    alt: "Cold Breakfast Noodles - Osaka, Japan",
  },
  {
    src: "../../assets/imgs/food/vietnam-ho-chi-minh-pho-cau.jpeg",
    alt: "Pho Cau - Ho Chi Minh City, Vietnam",
  },
  {
    src: "../../assets/imgs/food/south-korea-hotpot.jpeg",
    alt: "Hotpot - South Korea",
  },
  {
    src: "../../assets/imgs/food/vietnam-hoi-an-white-rose-dumplings.jpeg",
    alt: "White Rose Dumplings - Hoi An, Vietnam",
  },
  {
    src: "../../assets/imgs/food/japan-kyoto-potstickers.jpeg",
    alt: "Potstickers - Kyoto, Japan",
  },
  {
    src: "../../assets/imgs/food/bali-uluwatu-green-curry.jpeg",
    alt: "Green Curry - Uluwatu, Bali",
  },
  {
    src: "../../assets/imgs/food/vietnam-hanoi-pho.jpeg",
    alt: "Pho - Hanoi, Vietnam",
  },
  {
    src: "../../assets/imgs/food/bali-ubud-thai-stir-fry.jpeg",
    alt: "Chicken Stir Fry - Ubud, Bali",
  },
  {
    src: "../../assets/imgs/food/bali-ubud-mie-goreng.jpeg",
    alt: "Mie Goreng - Ubud, Bali",
  },
];

const cTierImages = [
  {
    src: "../../assets/imgs/food/vietnam-hoi-an-white-rose-dumplings-2.jpeg",
    alt: "White Rose Dumplings - Hoi An, Vietnam",
  },
  {
    src: "../../assets/imgs/food/japan-kyoto-conveyor-belt-sushi.jpeg",
    alt: "Conveyor Belt Sushi - Kyoto, Japan",
  },
  {
    src: "../../assets/imgs/food/bali-ubud-pad-thai.jpeg",
    alt: "Pad Thai - Ubud, Bali",
  },
  {
    src: "../../assets/imgs/food/vietnam-hanoi-chili-chicken.jpeg",
    alt: "Chili Chicken - Hanoi, Vietnam",
  },
  {
    src: "../../assets/imgs/food/vietnam-hanoi-beef-and-veg.jpeg",
    alt: "Beef and Veg - Hanoi, Vietnam",
  },
  {
    src: "../../assets/imgs/food/vietnam-hoi-an-spring-rolls.jpeg",
    alt: "Spring Rolls - Hoi An, Vietnam",
  },
  {
    src: "../../assets/imgs/food/japan-tokyo-taiyaki.jpeg",
    alt: "Taiyaki - Tokyo, Japan",
  },
  {
    src: "../../assets/imgs/food/vietnam-hanoi-spring-rolls.jpeg",
    alt: "Spring Rolls - Hanoi, Vietnam",
  },
  {
    src: "../../assets/imgs/food/bali-uluwatu-beef-noodles.jpeg",
    alt: "Beef Noodles - Uluwatu, Bali",
  },
  {
    src: "../../assets/imgs/food/bali-ubud-chili-noodles.jpeg",
    alt: "Chili Noodles - Ubud, Bali",
  },
  {
    src: "../../assets/imgs/food/vietnam-hoi-an-beef-noodle-soup.jpeg",
    alt: "Beef Noodle Soup - Hoi An, Vietnam",
  },
  {
    src: "../../assets/imgs/food/bali-uluwatu-pork-bao-buns.jpeg",
    alt: "Pork Bao Buns - Uluwatu, Bali",
  },
  {
    src: "../../assets/imgs/food/japan-osaka-okonomiyaki.jpeg",
    alt: "Okonomiyaki - Osaka, Japan",
  },
];

const dTierImages = [
  {
    src: "../../assets/imgs/food/bali-uluwatu-dragon-fruit-smoothie.jpeg",
    alt: "Dragon Fruit Smoothie - Uluwatu, Bali",
  },
  {
    src: "../../assets/imgs/food/vietnam-hoi-an-banh-mi.jpeg",
    alt: "Banh Mi - Hoi An, Vietnam",
  },
  {
    src: "../../assets/imgs/food/bali-ubud-chili-fries.jpeg",
    alt: "Chili Fries - Ubud, Bali",
  },
  {
    src: "../../assets/imgs/food/japan-osaka-takoyaki.jpeg",
    alt: "Takoyaki - Osaka, Japan",
  },
  {
    src: "../../assets/imgs/food/japan-tokyo-real-wasabi.jpeg",
    alt: "Real Wasabi - Tokyo, Japan",
  },
  {
    src: "../../assets/imgs/food/vietnam-ho-chi-minh-banh-mi.jpeg",
    alt: "Banh Mi - Ho Chi Minh City, Vietnam",
  },
  {
    src: "../../assets/imgs/food/vietnam-ho-chi-minh-banh-mi-2.jpeg",
    alt: "Banh Mi - Ho Chi Minh City, Vietnam",
  },
  {
    src: "../../assets/imgs/food/bali-uluwatu-breakfast.jpeg",
    alt: "Egg Breakfast - Uluwatu, Bali",
  },
  {
    src: "../../assets/imgs/food/bali-uluwatu-coconut.jpeg",
    alt: "Coconut - Uluwatu, Bali",
  },
  {
    src: "../../assets/imgs/food/japan-osaka-7-11-rice-roll.jpeg",
    alt: "7-11 Rice Roll - Osaka, Japan",
  },
  {
    src: "../../assets/imgs/food/japan-osaka-piplup-ice-cream.jpeg",
    alt: "Ice Cream - Osaka, Japan",
  },
  {
    src: "../../assets/imgs/food/vietnam-ho-chi-minh-street-food.jpeg",
    alt: "Street Food - Ho Chi Minh City, Vietnam",
  },
];

const fTierImages = [
  {
    src: "../../assets/imgs/food/vietnam-hanoi-cobra.jpeg",
    alt: "Cobra - Hanoi, Vietnam",
  },
  {
    src: "../../assets/imgs/food/vietnam-hanoi-snake-spring-rolls.jpeg",
    alt: "Bamboo Snake Spring Rolls - Hanoi, Vietnam",
  },
  {
    src: "../../assets/imgs/food/vietnam-ho-chi-minh-heart-meat.jpeg",
    alt: "Noodles w/ Heart Meat - Ho Chi Minh City, Vietnam",
  },
];

const tierMap = {
  "tier-s": sTierImages,
  "tier-a": aTierImages,
  "tier-b": bTierImages,
  "tier-c": cTierImages,
  "tier-d": dTierImages,
  "tier-f": fTierImages,
};

function loadImages() {
  let imagesLoaded = 0;
  const totalImages = Object.values(tierMap).flat().length;

  for (const tier in tierMap) {
    const imageArray = tierMap[tier];
    const tierItems = document.querySelector(`.${tier} .tier-items`);

    imageArray.forEach((imageObj) => {
      const item = document.createElement("div");
      item.classList.add("item");

      const img = document.createElement("img");
      img.src = imageObj.src;
      img.alt = imageObj.alt;
      img.draggable = false;

      img.onload = () => {
        imagesLoaded++;
        if (imagesLoaded === totalImages) {
          addEventListeners();
        }
      };

      item.appendChild(img);
      tierItems.appendChild(item);
    });
  }
}

function addEventListeners() {
  const items = document.querySelectorAll(".item");
  const tiers = document.querySelectorAll(".tier-items");

  items.forEach((item) => {
    item.draggable = true;
    item.addEventListener("dragstart", dragStart);
    item.addEventListener("dragend", dragEnd);
  });

  tiers.forEach((tier) => {
    tier.addEventListener("dragover", dragOver);
    tier.addEventListener("dragenter", dragEnter);
    tier.addEventListener("dragleave", dragLeave);
    tier.addEventListener("drop", drop);
  });

  const images = document.querySelectorAll(".item img");
  images.forEach((img) => {
    img.addEventListener("dblclick", enlargeImage);
  });
}

let draggedItem = null;

function dragStart(e) {
  draggedItem = this;
  const img = this.querySelector("img");

  if (img) {
    e.dataTransfer.setData("text/plain", "dragging");
    e.dataTransfer.setDragImage(img, 0, 0);
  }

  this.classList.add("dragging");
}

function dragEnd() {
  const tiers = document.querySelectorAll(".tier-items");
  tiers.forEach((tier) => {
    tier.classList.remove("drag-over");
  });

  if (draggedItem) {
    draggedItem.classList.remove("dragging");
  }
}

function dragOver(e) {
  e.preventDefault();
  this.classList.add("drag-over");

  const afterElement = getDragAfterElement(this, e.clientX, e.clientY);
  const items = this.querySelectorAll(".item:not(.dragging)");

  // reset margins for all items
  items.forEach((item) => {
    item.style.marginLeft = "5px";
    item.style.marginRight = "5px";
  });

  if (afterElement == null) {
    // if dragged item is at the end, no change needed as the item will be appended
  } else if (afterElement === items[0]) {
    // if dragged item is at the beginning
    afterElement.style.marginLeft = "15px";
  } else {
    // if dragged item is in the middle
    afterElement.style.marginLeft = "15px";
  }
}

function getDragAfterElement(container, x, y) {
  const draggableElements = [
    ...container.querySelectorAll(".item:not(.dragging)"),
  ];

  return draggableElements.reduce(
    (closest, child) => {
      const box = child.getBoundingClientRect();
      const offsetX = x - box.left - box.width / 2;
      const offsetY = y - box.top - box.height / 2;

      // prioritize elements on the same line
      if (offsetY > -box.height / 2 && offsetY < box.height / 2) {
        if (offsetX < 0 && offsetX > closest.offset) {
          return { offset: offsetX, element: child };
        }
      }

      return closest;
    },
    { offset: Number.NEGATIVE_INFINITY, element: null }
  ).element;
}

function dragEnter(e) {
  e.preventDefault();
  this.classList.add("drag-over");
}

function dragLeave(e) {
  this.classList.remove("drag-over");

  this.querySelectorAll(".item:not(.dragging)").forEach((item) => {
    item.style.marginLeft = "5px";
    item.style.marginRight = "5px";
  });
}

function drop(e) {
  this.classList.remove("drag-over");

  // reset margins for all items
  this.querySelectorAll(".item:not(.dragging)").forEach((item) => {
    item.style.marginLeft = "5px";
    item.style.marginRight = "5px";
  });

  const afterElement = getDragAfterElement(this, e.clientX, e.clientY);
  if (afterElement == null) {
    this.appendChild(draggedItem);
  } else {
    this.insertBefore(draggedItem, afterElement);
  }

  draggedItem.classList.remove("dragging");
  updateImageArrays();
  draggedItem = null;
}

function updateImageArrays() {
  for (const tier in tierMap) {
    const tierItems = document.querySelector(`.${tier} .tier-items`);
    const imageElements = tierItems.querySelectorAll(".item img");
    tierMap[tier] = Array.from(imageElements).map((img) => img.src);
  }
}

function enlargeImage(e) {
  const img = e.target;
  img.classList.toggle("enlarged");

  // create or remove caption
  if (img.classList.contains("enlarged")) {
    const caption = document.createElement("div");
    caption.classList.add("image-caption");
    caption.textContent = img.alt || "No caption available";
    img.parentNode.appendChild(caption);
  } else {
    const caption = img.parentNode.querySelector(".image-caption");
    if (caption) {
      caption.remove();
    }
  }
}

window.addEventListener("load", loadImages);
